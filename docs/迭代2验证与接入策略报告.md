# 迭代 2 验证与接入策略报告

## 1. 文档转换端到端验证结果

- **测试用例**：`DocumentConversionIntegrationTests.ConvertVariousDocuments_ToPdfStreams_AllValid`
- **覆盖范围**：
  - Word (`.docx`) -> PDF
  - Excel (`.xlsx`) -> PDF（包含列压缩设置）
  - 图片（`.png`）-> PDF
- **执行情况**：测试通过，确认所有转换器均可生成可打开的 PDF 文档。
- **记录方式**：单元测试项目新增 `DocumentConversionIntegrationTests.cs`，执行命令：
  ```bash
  dotnet test tests/PrintAssistant.Tests/PrintAssistant.Tests.csproj --filter DocumentConversionIntegrationTests
  ```

## 2. PDF 合并性能与内存评估

- **测试用例**：`DocumentConversionIntegrationTests.PdfMerge_PerformanceBaseline_LogsMetrics`
- **样本规模**：20 个单页 PDF 流
- **测试环境**：本地开发机 Windows 10，.NET 8.0，Debug 构建
- **指标结果**（来自 `TestResults/DocumentConversionIntegrationTests.trx`）：
  - 合并耗时：约 153 ms
  - 页数统计：20 页
  - 内存增量：约 0.01 MB（GC 后测量）
- **结论**：在小规模任务下性能和内存占用符合预期。后续迭代可通过增大样本数量、启用 Release 构建与实测大文件验证更大负载场景。

## 3. 真实打印服务接入策略

### 3.1 设计思路

1. **分层结构**：
   - 保留 `IPrintService` 接口，新增 `WindowsPrintService` 作为正式实现，继续保留 `MockPrintService` 供测试/演示使用。
   - 通过配置 (`AppSettings.Printing.UseMockPrintService`) 控制注入哪种实现。

2. **依赖与技术选型**：
   - 首选 `System.Printing` 与 `PrintQueue` API 实现静默打印（需启用 Windows Desktop SDK）。
   - 若目标环境限制 `System.Printing`，备用方案使用 `PrintDocument` 或调用 Win32 API (`OpenPrinter`/`StartDocPrinter`)。

3. **作业流程**：
   - 将合并后的 PDF 写入临时文件，使用 `PdfDocument` -> XPS 转换或直接利用 Syncfusion PDF 打印 API（若许可覆盖）。
   - 配置打印机、份数、双面等属性后提交队列，并监听打印结果（`PrintSystemJobInfo`）。

4. **错误处理与重试**：
   - 捕获打印队列异常，更新 `PrintJob.Status`，并在 `PrintProcessorService` 中触发重试或降级策略。
   - 记录详细日志（打印机不可达、权限不足、纸盒缺纸等）。

### 3.2 代码结构调整建议

| 模块 | 调整方案 |
| --- | --- |
| `Program.cs` | 按配置切换注入 `MockPrintService` 或 `WindowsPrintService`；支持多环境构建。 |
| `PrintService.cs` | 重命名为 `WindowsPrintService.cs` 并实现真实打印逻辑；新增 `WindowsPrintOptions` 配置类。 |
| `AppSettings.Printing` | 增加 `UseMockPrintService`、`PrinterNameOverride`、`TempPrintDirectory` 等字段。 |
| `PrintProcessorService` | 在打印前判断配置、如需临时文件则调用 `IFileSystem` 在指定目录生成并传递路径。 |
| 日志与监控 | 扩展 Serilog 输出，增加打印耗时、队列 ID 等上下文信息，便于运维追踪。 |

### 3.3 后续任务

1. 实现 `WindowsPrintService` 并补充集成测试（可配置 `UseMockPrintService=true` 以避免测试机实际打印）。
2. 在迭代 3 中引入打印机健康检查、重试策略与用户通知机制。
3. 编写部署手册，指导如何在生产环境配置默认打印机、驱动和权限。

---

> 本报告随迭代推进持续更新，作为迭代 2 的验证记录与后续真实打印接入的蓝图参考。

