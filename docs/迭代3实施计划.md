# 迭代 3 实施计划

## 1. 迭代目标

- **健壮性强化**：完善打印全流程的异常捕获、重试与状态可观测能力，确保在真实生产环境中遇到异常可快速恢复。
- **真实打印交付**：基于规划书指定的架构，落地 `WindowsPrintService`，完成从合并 PDF 到打印机队列的端到端闭环。
- **发布准备**：建立日志保留、配置覆盖、权限检查和安装打包方案，形成可重复交付的版本制品。
- **质量门禁**：在既有迭代 2 验证成果基础上（参考 `DocumentConversionIntegrationTests` 和 `FileConverterFactoryTests` 等结果），扩展测试体系，使关键路径覆盖率 ≥95%。

## 2. 前置依赖与参考

- 迭代 2 成果文档：`docs/迭代2验证与接入策略报告.md`（包含文档转换性能指标、真实打印接入策略）。
- 测试基线：`DocumentConversionIntegrationTests`（Word/Excel/Image -> PDF）、`FileConverterFactoryTests`（透传大文件、错误场景）。
- 规则与规划：
  - `docs/托盘打印助手PrintAssistant项目规划01.md`
  - `docs/standards/项目开发规则.md`
  - `docs/PrintAssistant 完整项目代码.md`（保持实现对齐）。

## 3. 工作分解

### 3.1 异常处理与重试（优先级 P1）
- 梳理 `PrintProcessorService` 及各服务的异常来源，定义可重试 / 不可重试分类。
- 实现重试策略（建议使用策略类或多态封装，支持最大次数、退避间隔）。
- 扩展日志与托盘通知，记录 `JobStatus` 与失败详情。
- 新增针对转换失败、打印机不可用、归档异常的单元 / 集成测试。

### 3.2 真实打印实现（优先级 P1）
- 实现 `WindowsPrintService`（遵循 DI 注入），支持配置覆盖、Mock 切换。
- 处理打印参数（打印机名称、份数、双面等），监听 `PrintSystemJobInfo` 状态。
- 构建临时文件策略，确保合并 PDF 可被打印驱动消费。
- 编写集成或手动脚本验证常用打印机；更新托盘 UI 显示。

### 3.3 日志 / 配置 / 权限（优先级 P2）
- 设计日志滚动与保留策略（可扩展到集中式存储）。
- 增强 `AppSettings`：如 `Printing.UseMockPrintService`、`Logging.RetentionDays` 等。
- 编写启动自检（打印机、目录权限、许可证检测）并输出结果。
- 撰写部署说明，确保 `appsettings.Secret.json` 管理规范。

### 3.4 安装与发布（优先级 P3）
- 评估打包方案（MSI / MSIX / ClickOnce），优先选用能满足权限要求的路径。
- 准备构建脚本（PowerShell 或 `dotnet publish` + WiX 等）。
- 记录安装、升级、卸载流程及常见问题处理。

## 4. 交付与验证里程碑

| 阶段 | 交付物 | 验证方式 |
| --- | --- | --- |
| M1 | 异常分类文档、重试策略原型 | 单元测试（Mock 失败），手工验证日志输出 |
| M2 | `WindowsPrintService` 初版、配置开关 | 集成测试（打印模拟 / 打印机隔离环境），日志检查 |
| M3 | 日志与配置增强、启动自检 | 自动化测试（配置覆盖），文档评审 |
| M4 | 安装包、部署手册 | 试安装记录、回归测试（含迭代 2 用例） |

验收前必须重复执行：
- `dotnet restore`、`dotnet test`（全量）
- 根据需要添加性能回归脚本（参考迭代 2 测试数据）
- 人工演示真实打印及错误处理流程

## 5. 风险与应对

- **打印驱动差异**：提前确定验证机型，必要时使用抽象层隔离驱动差异。
- **权限不足 / 服务会话限制**：在自检中暴露，并提供提示或文档指导用户调整。
- **安装包复杂度**：若短期难以完成 MSI，可阶段性交付 `dotnet publish` 可执行包 + 手动部署说明，并在计划中标注后续升级。
- **测试环境依赖真实打印机**：在 CI 时使用 Mock；在验收环境安排人工测试并记录日志。

## 6. 沟通与文档更新

- 每个阶段完成后更新 `docs/迭代2验证与接入策略报告.md` 或新增章节，记录验证数据。
- 在 `PrintAssistant 完整项目代码.md` 同步代码结构变更。
- 提交说明按规则标准化（例如 `feat: implement windows print service`）。

---

> 本实施计划为迭代 3 的路线图。执行过程若需调整，必须先更新本文件并与项目规划保持一致。

