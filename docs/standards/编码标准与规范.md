# PrintAssistant ç¼–ç æ ‡å‡†ä¸è§„èŒƒ

## ğŸ“‹ åŸºäºé¡¹ç›®è§„åˆ’ä¹¦çš„ç¼–ç æ ‡å‡†

æœ¬ç¼–ç æ ‡å‡†åŸºäº **ã€Šæ‰˜ç›˜æ‰“å°åŠ©æ‰‹PrintAssistanté¡¹ç›®è§„åˆ’01.mdã€‹** åˆ¶å®šï¼Œç¡®ä¿ä»£ç è´¨é‡ä¸æ¶æ„è®¾è®¡çš„ä¸€è‡´æ€§ã€‚

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

### 1. æ¶æ„ä¸€è‡´æ€§åŸåˆ™
- æ‰€æœ‰ä»£ç å®ç°å¿…é¡»ä¸¥æ ¼éµå¾ªé¡¹ç›®è§„åˆ’ä¹¦ä¸­çš„æ¶æ„è®¾è®¡
- è®¾è®¡æ¨¡å¼åº”ç”¨å¿…é¡»ä¸è§„åˆ’ä¹¦ä¿æŒä¸€è‡´
- æŠ€æœ¯æ ˆé€‰æ‹©å¿…é¡»ç¬¦åˆè§„åˆ’ä¹¦è¦æ±‚

### 2. å¯æµ‹è¯•æ€§åŸåˆ™
- æ‰€æœ‰å¤–éƒ¨ä¾èµ–å¿…é¡»é€šè¿‡æ¥å£æŠ½è±¡åŒ–
- ä½¿ç”¨ä¾èµ–æ³¨å…¥è€Œéé™æ€ä¾èµ–
- æ¯ä¸ªç±»å’Œæ–¹æ³•éƒ½å¿…é¡»å¯è¿›è¡Œå•å…ƒæµ‹è¯•

### 3. æ–‡æ¡£å®Œæ•´æ€§åŸåˆ™
- æ¯ä¸ªæ¨¡å—/ç±»éƒ½è¦æœ‰æ³¨é‡Šè¯´æ˜è¾“å…¥è¾“å‡ºç±»å‹åŠè¦æ±‚
- ä½¿ç”¨XMLæ–‡æ¡£æ³¨é‡Š
- ä¿æŒUTF-8 BOMç¼–ç ï¼Œé˜²æ­¢ä¸­æ–‡ä¹±ç 

## ğŸ—ï¸ æ¶æ„å®ç°æ ‡å‡†

### 1. ä¾èµ–æ³¨å…¥æ ‡å‡†

#### æ„é€ å‡½æ•°æ³¨å…¥
```csharp
// âœ… æ­£ç¡®ï¼šä½¿ç”¨æ„é€ å‡½æ•°æ³¨å…¥
public class FileMonitorService : IFileMonitor
{
    private readonly IFileSystem _fileSystem;
    private readonly ILogger<FileMonitorService> _logger;
    
    public FileMonitorService(IFileSystem fileSystem, ILogger<FileMonitorService> logger)
    {
        _fileSystem = fileSystem ?? throw new ArgumentNullException(nameof(fileSystem));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }
}

// âŒ é”™è¯¯ï¼šä½¿ç”¨é™æ€ä¾èµ–
public class FileMonitorService : IFileMonitor
{
    public void StartMonitoring(string path)
    {
        var watcher = new FileSystemWatcher(path); // ç›´æ¥ä½¿ç”¨é™æ€ç±»
    }
}
```

#### æœåŠ¡ç”Ÿå‘½å‘¨æœŸé€‰æ‹©
```csharp
// å•ä¾‹æœåŠ¡ï¼šæŒæœ‰çŠ¶æ€æˆ–ä»£è¡¨å…±äº«èµ„æº
services.AddSingleton<IPrintQueue, PrintQueueService>();
services.AddSingleton<IFileMonitor, FileMonitorService>();

// ç¬æ€æœåŠ¡ï¼šæ— çŠ¶æ€ã€è½»é‡çº§
services.AddTransient<IFileConverter, WordToPdfConverter>();
services.AddTransient<SettingsForm>();
```

### 2. é…ç½®ç®¡ç†æ ‡å‡†

#### Optionsæ¨¡å¼å®ç°
```csharp
// âœ… æ­£ç¡®ï¼šä½¿ç”¨å¼ºç±»å‹é…ç½®
public class MonitorSettings
{
    public string Path { get; set; } = string.Empty;
    public int DebounceIntervalMilliseconds { get; set; } = 2500;
}

public class FileMonitorService : IFileMonitor
{
    private readonly MonitorSettings _settings;
    
    public FileMonitorService(IOptions<MonitorSettings> options)
    {
        _settings = options.Value;
    }
}

// âŒ é”™è¯¯ï¼šç›´æ¥ä½¿ç”¨IConfiguration
public class FileMonitorService : IFileMonitor
{
    private readonly IConfiguration _configuration;
    
    public FileMonitorService(IConfiguration configuration)
    {
        _configuration = configuration;
    }
    
    public void StartMonitoring()
    {
        var path = _configuration["ApplicationSettings:Monitoring:Path"]; // å­—ç¬¦ä¸²é”®
    }
}
```

### 3. æ—¥å¿—è®°å½•æ ‡å‡†

#### ç»“æ„åŒ–æ—¥å¿—
```csharp
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—
_logger.LogInformation("å¼€å§‹ç›‘æ§æ–‡ä»¶å¤¹ {Path}ï¼Œé˜²æŠ–é—´éš” {Interval}ms", 
    _settings.Path, _settings.DebounceIntervalMilliseconds);

_logger.LogWarning("æ–‡ä»¶è½¬æ¢å¤±è´¥ {FilePath}ï¼Œé”™è¯¯ï¼š{Error}", 
    filePath, ex.Message);

// âŒ é”™è¯¯ï¼šä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥
_logger.LogInformation("å¼€å§‹ç›‘æ§æ–‡ä»¶å¤¹ " + _settings.Path);
```

### 4. å¼‚æ­¥ç¼–ç¨‹æ ‡å‡†

#### å¼‚æ­¥æ–¹æ³•å®ç°
```csharp
// âœ… æ­£ç¡®ï¼šä½¿ç”¨async/await
public async Task<Stream> ConvertToPdfAsync(string sourceFilePath)
{
    using var fileStream = _fileSystem.File.OpenRead(sourceFilePath);
    using var wordDocument = new WordDocument(fileStream, FormatType.Automatic);
    using var renderer = new DocIORenderer();
    
    var pdfDocument = renderer.ConvertToPDF(wordDocument);
    var pdfStream = new MemoryStream();
    
    await Task.Run(() => pdfDocument.Save(pdfStream));
    pdfStream.Position = 0;
    
    return pdfStream;
}

// âŒ é”™è¯¯ï¼šé˜»å¡è°ƒç”¨
public Stream ConvertToPdf(string sourceFilePath)
{
    var fileStream = _fileSystem.File.OpenRead(sourceFilePath);
    // åŒæ­¥é˜»å¡æ“ä½œ
    return ConvertToPdfSync(fileStream);
}
```

## ğŸ“ ä»£ç æ³¨é‡Šæ ‡å‡†

### 1. XMLæ–‡æ¡£æ³¨é‡Š

#### ç±»çº§åˆ«æ³¨é‡Š
```csharp
/// <summary>
/// æ–‡ä»¶ç›‘æ§æœåŠ¡ï¼Œè´Ÿè´£ç›‘æ§æŒ‡å®šæ–‡ä»¶å¤¹çš„æ–‡ä»¶å˜åŒ–å¹¶ç”Ÿæˆæ‰“å°ä½œä¸š
/// </summary>
/// <remarks>
/// å®ç°é˜²æŠ–æœºåˆ¶ï¼Œå°†è¿ç»­çš„æ–‡ä»¶æ·»åŠ æ“ä½œèšåˆä¸ºå•ä¸ªæ‰“å°ä½œä¸šã€‚
/// ä½¿ç”¨FileSystemWatcherç›‘æ§æ–‡ä»¶ç³»ç»Ÿäº‹ä»¶ï¼Œå¹¶é€šè¿‡äº‹ä»¶é˜²æŠ–é¿å…ä»»åŠ¡ç¢ç‰‡åŒ–ã€‚
/// </remarks>
public class FileMonitorService : IFileMonitor
{
    // å®ç°...
}
```

#### æ–¹æ³•çº§åˆ«æ³¨é‡Š
```csharp
/// <summary>
/// å¼€å§‹ç›‘æ§æŒ‡å®šè·¯å¾„çš„æ–‡ä»¶å¤¹
/// </summary>
/// <param name="path">è¦ç›‘æ§çš„æ–‡ä»¶å¤¹è·¯å¾„</param>
/// <exception cref="ArgumentException">å½“è·¯å¾„ä¸ºç©ºæˆ–ä¸å­˜åœ¨æ—¶æŠ›å‡º</exception>
/// <exception cref="UnauthorizedAccessException">å½“æ²¡æœ‰è®¿é—®æƒé™æ—¶æŠ›å‡º</exception>
/// <returns>è¡¨ç¤ºå¼‚æ­¥æ“ä½œçš„ä»»åŠ¡</returns>
public async Task StartMonitoringAsync(string path)
{
    // å®ç°...
}
```

#### å±æ€§æ³¨é‡Š
```csharp
/// <summary>
/// è·å–æˆ–è®¾ç½®ä½œä¸šçš„å”¯ä¸€æ ‡è¯†ç¬¦
/// </summary>
/// <value>GUIDæ ¼å¼çš„ä½œä¸šID</value>
public Guid JobId { get; set; }

/// <summary>
/// è·å–ä½œä¸šçš„å½“å‰çŠ¶æ€
/// </summary>
/// <value>ä½œä¸šçŠ¶æ€æšä¸¾å€¼</value>
public JobStatus Status { get; set; }
```

### 2. å†…è”æ³¨é‡Šæ ‡å‡†

```csharp
public async Task ProcessJobAsync(PrintJob job, CancellationToken cancellationToken)
{
    try
    {
        // æ›´æ–°ä½œä¸šçŠ¶æ€ä¸ºå¤„ç†ä¸­
        job.Status = JobStatus.Processing;
        await _trayIconService.UpdateStatusAsync(job);
        
        // éªŒè¯æºæ–‡ä»¶æ˜¯å¦ä»ç„¶å­˜åœ¨
        var existingFiles = new List<string>();
        foreach (var filePath in job.SourceFilePaths)
        {
            if (_fileSystem.File.Exists(filePath))
            {
                existingFiles.Add(filePath);
            }
            else
            {
                _logger.LogWarning("æºæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡å¤„ç†ï¼š{FilePath}", filePath);
            }
        }
        
        // å¦‚æœæ‰€æœ‰æ–‡ä»¶éƒ½ä¸å­˜åœ¨ï¼Œæ ‡è®°ä½œä¸šä¸ºå¤±è´¥
        if (existingFiles.Count == 0)
        {
            job.Status = JobStatus.Failed;
            job.ErrorMessage = "æ‰€æœ‰æºæ–‡ä»¶éƒ½ä¸å­˜åœ¨";
            return;
        }
        
        // è½¬æ¢æ–‡ä»¶ä¸ºPDF
        var pdfStreams = new List<Stream>();
        foreach (var filePath in existingFiles)
        {
            var converter = _converterFactory.GetConverter(filePath);
            if (converter != null)
            {
                var pdfStream = await converter.ConvertToPdfAsync(filePath);
                pdfStreams.Add(pdfStream);
            }
            else
            {
                // ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹ï¼Œç§»åŠ¨åˆ°æŒ‡å®šæ–‡ä»¶å¤¹
                await _fileArchiver.MoveUnsupportedFileAsync(filePath);
            }
        }
        
        // åˆå¹¶PDFå¹¶æ‰§è¡Œæ‰“å°
        if (pdfStreams.Count > 0)
        {
            var mergedPdf = await _pdfMerger.MergeAsync(pdfStreams);
            await _printService.PrintPdfAsync(mergedPdf, job.SelectedPrinter, job.Copies);
            
            // å½’æ¡£æºæ–‡ä»¶
            await _fileArchiver.ArchiveFilesAsync(existingFiles, job.CreationTime);
            
            job.Status = JobStatus.Completed;
        }
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "å¤„ç†ä½œä¸šå¤±è´¥ {JobId}", job.JobId);
        job.Status = JobStatus.Failed;
        job.ErrorMessage = ex.Message;
    }
    finally
    {
        // æ›´æ–°æ‰˜ç›˜å›¾æ ‡çŠ¶æ€
        await _trayIconService.UpdateStatusAsync(job);
    }
}
```

## ğŸ§ª æµ‹è¯•æ ‡å‡†

### 1. å•å…ƒæµ‹è¯•ç»“æ„

```csharp
/// <summary>
/// FileMonitorServiceçš„å•å…ƒæµ‹è¯•
/// </summary>
public class FileMonitorServiceTests
{
    private readonly Mock<IFileSystem> _mockFileSystem;
    private readonly Mock<IPrintQueue> _mockPrintQueue;
    private readonly Mock<ILogger<FileMonitorService>> _mockLogger;
    private readonly FileMonitorService _service;
    
    public FileMonitorServiceTests()
    {
        _mockFileSystem = new Mock<IFileSystem>();
        _mockPrintQueue = new Mock<IPrintQueue>();
        _mockLogger = new Mock<ILogger<FileMonitorService>>();
        
        _service = new FileMonitorService(
            _mockFileSystem.Object,
            _mockPrintQueue.Object,
            _mockLogger.Object);
    }
    
    [Fact]
    public async Task StartMonitoring_WhenFilesAdded_ShouldAggregateIntoJob()
    {
        // Arrange
        var testPath = @"C:\test";
        var mockFileSystem = new MockFileSystem();
        
        // Act
        await _service.StartMonitoringAsync(testPath);
        
        // æ¨¡æ‹Ÿæ–‡ä»¶æ·»åŠ 
        mockFileSystem.AddFile(@"C:\test\file1.txt", "content1");
        mockFileSystem.AddFile(@"C:\test\file2.txt", "content2");
        
        // ç­‰å¾…é˜²æŠ–é—´éš”
        await Task.Delay(3000);
        
        // Assert
        _mockPrintQueue.Verify(
            x => x.EnqueueJobAsync(It.Is<PrintJob>(job => 
                job.SourceFilePaths.Count == 2)), 
            Times.Once);
    }
}
```

### 2. æµ‹è¯•å‘½åè§„èŒƒ

```csharp
// æ ¼å¼ï¼šMethodName_Scenario_ExpectedResult
[Fact]
public async Task ConvertToPdfAsync_WhenValidWordFile_ShouldReturnPdfStream()
{
    // æµ‹è¯•å®ç°...
}

[Fact]
public async Task ConvertToPdfAsync_WhenFileNotFound_ShouldThrowFileNotFoundException()
{
    // æµ‹è¯•å®ç°...
}

[Fact]
public async Task ConvertToPdfAsync_WhenCorruptedFile_ShouldThrowInvalidOperationException()
{
    // æµ‹è¯•å®ç°...
}
```

## ğŸ”§ é”™è¯¯å¤„ç†æ ‡å‡†

### 1. å¼‚å¸¸å¤„ç†æ¨¡å¼

```csharp
// âœ… æ­£ç¡®ï¼šå…·ä½“çš„å¼‚å¸¸å¤„ç†
public async Task<Stream> ConvertToPdfAsync(string sourceFilePath)
{
    try
    {
        if (!_fileSystem.File.Exists(sourceFilePath))
        {
            throw new FileNotFoundException($"æºæ–‡ä»¶ä¸å­˜åœ¨ï¼š{sourceFilePath}");
        }
        
        // è½¬æ¢é€»è¾‘...
    }
    catch (SyncfusionException ex)
    {
        _logger.LogError(ex, "Syncfusionè½¬æ¢å¤±è´¥ï¼š{FilePath}", sourceFilePath);
        throw new DocumentConversionException($"æ–‡æ¡£è½¬æ¢å¤±è´¥ï¼š{ex.Message}", ex);
    }
    catch (UnauthorizedAccessException ex)
    {
        _logger.LogError(ex, "æ–‡ä»¶è®¿é—®æƒé™ä¸è¶³ï¼š{FilePath}", sourceFilePath);
        throw;
    }
}

// âŒ é”™è¯¯ï¼šæ•è·æ‰€æœ‰å¼‚å¸¸
public async Task<Stream> ConvertToPdfAsync(string sourceFilePath)
{
    try
    {
        // è½¬æ¢é€»è¾‘...
    }
    catch (Exception ex) // è¿‡äºå®½æ³›
    {
        _logger.LogError(ex, "è½¬æ¢å¤±è´¥");
        throw;
    }
}
```

### 2. è‡ªå®šä¹‰å¼‚å¸¸

```csharp
/// <summary>
/// æ–‡æ¡£è½¬æ¢å¼‚å¸¸
/// </summary>
public class DocumentConversionException : Exception
{
    public DocumentConversionException(string message) : base(message)
    {
    }
    
    public DocumentConversionException(string message, Exception innerException) 
        : base(message, innerException)
    {
    }
}

/// <summary>
/// æ‰“å°å¼‚å¸¸
/// </summary>
public class PrintingException : Exception
{
    public string PrinterName { get; }
    
    public PrintingException(string message, string printerName) : base(message)
    {
        PrinterName = printerName;
    }
    
    public PrintingException(string message, string printerName, Exception innerException) 
        : base(message, innerException)
    {
        PrinterName = printerName;
    }
}
```

## ğŸ“Š æ€§èƒ½æ ‡å‡†

### 1. å†…å­˜ç®¡ç†

```csharp
// âœ… æ­£ç¡®ï¼šä½¿ç”¨usingè¯­å¥ç®¡ç†èµ„æº
public async Task<Stream> ConvertToPdfAsync(string sourceFilePath)
{
    using var fileStream = _fileSystem.File.OpenRead(sourceFilePath);
    using var wordDocument = new WordDocument(fileStream, FormatType.Automatic);
    using var renderer = new DocIORenderer();
    
    var pdfDocument = renderer.ConvertToPDF(wordDocument);
    var pdfStream = new MemoryStream();
    
    pdfDocument.Save(pdfStream);
    pdfStream.Position = 0;
    
    return pdfStream;
}

// âŒ é”™è¯¯ï¼šæœªæ­£ç¡®é‡Šæ”¾èµ„æº
public async Task<Stream> ConvertToPdfAsync(string sourceFilePath)
{
    var fileStream = _fileSystem.File.OpenRead(sourceFilePath);
    var wordDocument = new WordDocument(fileStream, FormatType.Automatic);
    var renderer = new DocIORenderer();
    
    // èµ„æºæœªé‡Šæ”¾ï¼Œå¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼
    var pdfDocument = renderer.ConvertToPDF(wordDocument);
    var pdfStream = new MemoryStream();
    
    pdfDocument.Save(pdfStream);
    return pdfStream;
}
```

### 2. å¼‚æ­¥æ“ä½œ

```csharp
// âœ… æ­£ç¡®ï¼šé¿å…é˜»å¡è°ƒç”¨
public async Task ProcessJobAsync(PrintJob job, CancellationToken cancellationToken)
{
    // ä½¿ç”¨å¼‚æ­¥æ–¹æ³•
    var pdfStream = await _converter.ConvertToPdfAsync(job.SourceFilePath);
    
    // ä½¿ç”¨Task.RunåŒ…è£…åŒæ­¥æ“ä½œ
    await Task.Run(() => _printService.Print(pdfStream), cancellationToken);
}

// âŒ é”™è¯¯ï¼šé˜»å¡å¼‚æ­¥æ–¹æ³•
public async Task ProcessJobAsync(PrintJob job, CancellationToken cancellationToken)
{
    // é˜»å¡è°ƒç”¨
    var pdfStream = _converter.ConvertToPdf(job.SourceFilePath);
    
    // åŒæ­¥é˜»å¡
    _printService.Print(pdfStream);
}
```

## âœ… ä»£ç å®¡æŸ¥æ£€æŸ¥ç‚¹

### 1. æ¶æ„ä¸€è‡´æ€§æ£€æŸ¥
- [ ] æ˜¯å¦éµå¾ªäº†è§„åˆ’ä¹¦ä¸­çš„è®¾è®¡æ¨¡å¼ï¼Ÿ
- [ ] æ˜¯å¦ä½¿ç”¨äº†æ­£ç¡®çš„ä¾èµ–æ³¨å…¥æ–¹å¼ï¼Ÿ
- [ ] æ˜¯å¦å®ç°äº†è§„åˆ’ä¹¦ä¸­å®šä¹‰çš„æ¥å£ï¼Ÿ

### 2. å¯æµ‹è¯•æ€§æ£€æŸ¥
- [ ] æ‰€æœ‰å¤–éƒ¨ä¾èµ–æ˜¯å¦éƒ½å·²æŠ½è±¡åŒ–ï¼Ÿ
- [ ] æ˜¯å¦é¿å…äº†é™æ€ä¾èµ–ï¼Ÿ
- [ ] æ˜¯å¦å¯ä»¥é€šè¿‡ä¾èµ–æ³¨å…¥è¿›è¡Œæµ‹è¯•ï¼Ÿ

### 3. ä»£ç è´¨é‡æ£€æŸ¥
- [ ] æ˜¯å¦æœ‰å®Œæ•´çš„XMLæ–‡æ¡£æ³¨é‡Šï¼Ÿ
- [ ] æ˜¯å¦éµå¾ªäº†å‘½åè§„èŒƒï¼Ÿ
- [ ] æ˜¯å¦æ­£ç¡®å¤„ç†äº†å¼‚å¸¸ï¼Ÿ
- [ ] æ˜¯å¦æ­£ç¡®ç®¡ç†äº†èµ„æºï¼Ÿ

### 4. æ€§èƒ½æ£€æŸ¥
- [ ] æ˜¯å¦ä½¿ç”¨äº†å¼‚æ­¥æ“ä½œï¼Ÿ
- [ ] æ˜¯å¦æ­£ç¡®é‡Šæ”¾äº†èµ„æºï¼Ÿ
- [ ] æ˜¯å¦é¿å…äº†å†…å­˜æ³„æ¼ï¼Ÿ

---

**é‡è¦æé†’**ï¼šè¿™äº›ç¼–ç æ ‡å‡†æ˜¯ç¡®ä¿é¡¹ç›®è´¨é‡çš„åŸºç¡€ï¼Œè¯·åœ¨æ‰€æœ‰å¼€å‘å·¥ä½œä¸­ä¸¥æ ¼æ‰§è¡Œã€‚
