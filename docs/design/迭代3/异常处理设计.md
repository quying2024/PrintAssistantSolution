# 迭代 3 异常处理与重试设计

## 1. 目标

- 明确打印流水线的异常分类与责任归属，保证异常信息可观测、可恢复。
- 设计统一的重试策略（次数、时间间隔、退避机制），适配不同环节需求。
- 为后续 Windows 打印实现、日志体系、托盘 UI 更新提供可靠的状态基础。

## 2. 异常分类

| 环节 | 可能异常 | 可重试性 | 处理策略 |
| --- | --- | --- | --- |
| 文件转换 (`IFileConverter`) | 文件损坏、Syncfusion 处理失败、权限不足 | 取决于类型：
  - 损坏 / 不兼容：不可重试
  - 临时 IO/许可：可重试 | 捕获具体异常类型，记录日志；不可重试时标记失败并归档源文件至 `Unsupported`；可重试时进入重试流程 |
| PDF 合并 (`IPdfMerger`) | 流位置错误、内存不足 | 可重试（短暂资源问题） | 重置流后重试，超过阈值记录失败 |
| 打印 (`IPrintService`) | 打印机不可用、队列失败、驱动异常 | 可重试（可配置次数） | 首次失败时更新状态与日志；根据配置触发退避重试；多次失败后标记任务失败并通知用户 |
| 归档 (`IFileArchiver`) | 目标路径权限不足、磁盘满 | 可重试（资源临时不可用） | 重试若仍失败，输出错误并保持待归档状态，需人工干预 |
| Cover Page (`ICoverPageGenerator`) | PDF 生成失败 | 可重试（资源不足） | 记录日志，尝试重新生成，失败时可放弃封面但继续打印（可配置） |

## 3. 状态机与重试策略

- `PrintJob.Status` 新增状态：`Retrying`（记录当前重试次数与最后一次错误信息）。
- 引入 `JobExecutionContext`：
  ```csharp
  public record JobExecutionContext(PrintJob Job, int Attempt, Exception? LastError);
  ```
- 重试策略参数（可配置，默认值见下）：
  - `MaxRetryCount`：3
  - `InitialDelayMilliseconds`：1000
  - `BackoffFactor`：2（指数退避）
  - `MaxDelayMilliseconds`：30000
- 策略实现建议：
  - 新增 `IRetryPolicy` 接口与默认实现 `ExponentialBackoffRetryPolicy`
  ```csharp
  public interface IRetryPolicy
  {
      TimeSpan? GetDelay(int attempt);
  }
  ```
  - `GetDelay` 返回 `null` 表示不再重试。

## 4. PrintProcessorService 调整概览

1. `ProcessJobAsync` 拆分为多个步骤并结合重试策略：
   - `ConvertSourcesAsync`
   - `MergeAsync`
   - `PrintAsync`
   - `ArchiveAsync`
   - 每一步在异常发生时，根据策略决定是否重试。

2. 重试流程示意：
   ```mermaid
   flowchart TD
     A[开始处理] --> B{步骤执行}
     B -->|成功| C[进入下一步骤]
     B -->|失败| D{是否可重试}
     D -->|是| E[等待延迟]
     E --> B
     D -->|否| F[标记失败并退出]
   ```

3. 托盘 UI：
   - 在重试过程中显示 `Retrying` 状态与剩余尝试次数。
   - 多次失败后弹出气泡提示，附上错误信息。

## 5. 配置扩展

在 `AppSettings.Printing` 中新增：

```json
"Printing": {
  "UseMockPrintService": true,
  "GenerateCoverPage": true,
  "RetryPolicy": {
    "MaxRetryCount": 3,
    "InitialDelayMilliseconds": 1000,
    "BackoffFactor": 2,
    "MaxDelayMilliseconds": 30000,
    "RetryOn": [ "Conversion", "Merge", "Print", "Archive" ]
  }
}
```

- `RetryOn` 控制哪些阶段参与重试，默认全部开启。
- 日志配置中新增 `RetentionDays` 用于迭代 3 的日志保留策略。

## 6. 测试计划

- 单元测试：
  - 模拟转换失败可重试场景（通过 Moq 设置第一次抛出临时异常、第二次成功）。
  - 模拟不可重试异常，验证任务直接失败且错误信息记录。
  - 验证退避策略返回的延迟值与配置一致。
  - 验证托盘状态更新与日志输出。
- 集成测试：
  - 使用 Mock 打印服务模拟打印机不可用 -> 重试成功。
  - 配置重试次数为 0，验证立即失败。

## 7. 后续扩展

- 结合真实打印服务实现，将打印队列返回的错误码映射到重试策略。
- 在部署环境支持时，接入集中式日志/监控（如 Seq、Application Insights）。
- 在 `docs/迭代2验证与接入策略报告.md` 中追加异常处理验证章节，记录实测数据。

---

> 本设计文档将随迭代 3 进展持续更新，任何更改需与实施计划保持同步。

