# 日志配置与部署验证指南

本指南汇总迭代 3 中落地的日志与配置改造，面向运维与现场部署人员，帮助在不同环境快速完成配置、验证与问题排查。

## 1. 配置总览

- **日志框架**：Serilog（结构化日志、文件滚动与时间保留策略）。
- **配置文件**：`src/PrintAssistant/appsettings.json` → `ApplicationSettings.Logging` 节以及 `Serilog:WriteTo` 文件接收器。
- **代码支撑**：`Program.NormalizeSerilogFilePaths` + `Program.EnsureSerilogDirectories` 负责展开环境变量并在启动阶段创建日志目录。
- **默认行为**：若 `ApplicationSettings.Logging.Path` 留空，则使用 `AppContext.BaseDirectory` 下的 `Logs` 子目录（由 Serilog 配置中的 `Logs\log-.txt` 提供）。

## 2. 配置步骤

### 2.1 `appsettings.json` 修改要点

1. **日志目录**（必须保证写入权限）：
   ```json
   "ApplicationSettings": {
     "Logging": {
       "Path": "C:\\Tools\\PrintAssistant\\Logs",
       "RetentionDays": 14
     }
   }
   ```
   - 为空时默认落在应用目录 `Logs`。
   - 设置为绝对路径时，`NormalizeSerilogFilePaths` 会展开环境变量；`EnsureSerilogDirectories` 会提前创建目录。

2. **Serilog 文件接收器**：保持 RollingInterval=Day，避免随意调整 `rollingInterval` 与 `retainedFileTimeLimit`，以免破坏 1 周滚动的期望；如需自定义路径，请同步修改 `Args:path`。

3. **许可与敏感信息**：`appsettings.Secret.json` 仍只承载 Syncfusion 许可证，不应存放日志路径等环境信息。

### 2.2 程序启动时的行为

- `Program.cs` 中在 `Host` 构建之前执行：
  - 读取并展开 Serilog 配置中的所有文件路径。
  - 自动创建路径的父目录。
  - 在 DEBUG 构建下将路径打印到控制台，方便排查。
- `SerilogBootstrapTests` 覆盖该流程，启动时自动校验：
  - 目录被创建；
  - 至少生成一个非空日志文件（包含 “PrintAssistant host initializing.”）。

## 3. 验证流程

> 环境要求：Windows 10/11，已安装打印机驱动（真实打印或 `Microsoft Print to PDF` 均可）。

1. **构建与测试**（确保依赖完整）：
   ```powershell
   dotnet restore
   dotnet test tests/PrintAssistant.Tests/PrintAssistant.Tests.csproj
   ```
2. **配置日志目录**：编辑 `appsettings.json` → `ApplicationSettings.Logging.Path` 为具备写权限的绝对路径，例如 `C:\Data\PrintAssistant\Logs`。
3. **启动应用**：
   ```powershell
   dotnet run --project src/PrintAssistant/PrintAssistant.csproj
   ```
   首次启动日志中将记录 “PrintAssistant host initializing.”、“PrintAssistant host started.”。
4. **触发打印任务**：向监控目录放入 1–2 个测试文件，待托盘状态更新为 `archived` 或 `failed`。
5. **验证日志**：
   - 检查第 2 步指定目录是否已创建。
   - 确认存在形如 `log-20251003.txt` 的日志文件，文件大小 > 0 字节。
   - 打开文件确认包含处理过程中的 `Information`/`Warning` 记录。
6. **收尾**：退出托盘应用（右键托盘图标 → 退出），再执行 `dotnet run` 可重复验证。

### 3.1 2025-10-03 实测记录

- 环境：Windows 11，默认打印机 `Microsoft Print to PDF`，配置路径 `C:\Users\quying\PrintAssistantMonitorTest`，日志目录 `C:\Users\quying\PrintAssistantLogsTest`。
- 按步骤 1–5 操作，应用成功捕获 4 个测试文件（2 张 JPG、1 个 DOCX、1 个 PDF）。
- 托盘弹窗显示 `[Archived] 88.JPG, 2580J.jpg, IntelliDocs01说明.docx, VS Code Pyt`，确认托盘状态刷新。
- 归档目录生成：`C:\Users\quying\PrintAssistantMonitorTest\Processed_20251003_141846`，包含源文件与合并后的 PDF。
- 日志文件：`C:\Users\quying\PrintAssistantLogsTest\log-20251003.txt`，关键片段：
  ```text
  2025-10-03 07:18:46.977 -07:00 [INF] Detected new print job "edfaad72-48d2-46a3-b523-5d5105fc18c5" with 4 files.
  2025-10-03 07:18:51.310 -07:00 [INF] Merged PDF for job "edfaad72-48d2-46a3-b523-5d5105fc18c5" with 7 pages.
  2025-10-03 07:20:47.861 -07:00 [INF] MockPrintService: 模拟打印任务。打印机: Microsoft Print to PDF, 份数: 1, 数据流大小: 4291184 bytes.
  2025-10-03 07:20:48.893 -07:00 [INF] Job "edfaad72-48d2-46a3-b523-5d5105fc18c5" archived at C:\Users\quying\PrintAssistantMonitorTest\Processed_20251003_141846.
  ```
- 结论：日志路径重定向、监控/合并/打印/归档及托盘提示均符合迭代 3 目标，可作为部署验证基线。

## 4. 部署与安装建议

1. **发布命令**（框架依赖）：
   ```powershell
   dotnet publish src/PrintAssistant/PrintAssistant.csproj -c Release -r win-x64 --self-contained false -o dist/win-x64
   ```
2. **分发内容**：
   - `dist/win-x64` 目录全部文件；
   - `appsettings.json`、`appsettings.Secret.json`（可选）；
   - 第三方许可（Syncfusion）。
3. **安装步骤**：
   - 复制发布目录到目标机器（建议 `C:\Program Files\PrintAssistant`）。
   - 修改 `appsettings.json` 中监控路径、日志路径、默认打印机等配置。
   - 若需系统级安装，可使用 WiX/MSIX 封装发布目录，并在安装脚本中创建日志目录、设置文件 ACL。
4. **权限与服务自检**：
   - 确保运行账户对监控目录、日志目录、归档目录具有 `Read/Write/Create` 权限。
   - 启动应用后观察托盘提示与日志输出，确认无权限错误。

## 5. 常见问题排查

| 现象 | 排查步骤 |
| --- | --- |
| 日志目录未生成 | 检查 `ApplicationSettings.Logging.Path` 设置是否有效；确认 `EnsureSerilogDirectories` 未被异常中断（查看控制台输出）。 |
| 日志文件存在但为空 | 确认应用是否真正启动成功并获取托盘服务（日志至少包含启动与停止记录）；查看 `Serilog` 最小日志级别是否被设置过低。 |
| 启动时报权限错误 | 以管理员身份运行一次或为日志目录授予 `Modify` 权限；避免使用系统受保护目录（如 `C:\Windows\System32`）。 |
| 打印任务失败但无日志 | 确认 `ApplicationSettings.Printing.RetryPolicy` 未禁用 `RetryOn` 的 `Print` 阶段；检查打印机名称是否正确、驱动是否在线。 |

---

> 所有文档更新需与《托盘打印助手PrintAssistant项目规划01.md》保持一致；部署脚本与安装包调整请同步更新该指南及 `docs/PrintAssistant 完整项目代码.md` 中的示例配置。


